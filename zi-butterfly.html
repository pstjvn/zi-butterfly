<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="zi-butterfly">
  <template>
    <style>
      :host {
        display: block;
        width: 300px;
        height: 300px;
        @apply --layout-horizontal;
        animation-duration: 12s;
        animation-iteration-count: 5;
        animation-delay: 1s;
      }
      div {
        @apply --layout;
        perspective: 600px;
      }
      svg {
        width: 100%;
        height: 100%;
      }
      svg > path { stroke-width: 0; }
      .leftside { margin-right: 1%; }
      .rightside { margin-left: 1%; }
      .leftside, .rightside {
        animation-duration: inherit;
        animation-iteration-count: inherit;
        animation-delay: inherit;
      }
      .rightside > svg { transform-origin: 0% 50%; }
      .leftside > svg { transform-origin: 100% 50%; }
      .rightside > svg.ready {
        animation-name: wings-right;
        animation-duration: inherit;
        animation-iteration-count: inherit;
        animation-delay: inherit;
      }
      .leftside > svg.ready {
        animation-name: wings-left;
        animation-duration: inherit;
        animation-iteration-count: inherit;
        animation-delay: inherit;
      }

      @keyframes wings-right {
        0% { transform: rotateY(0deg); }
        1% { transform: rotateY(-25deg); }
        3% { transform: rotateY(-4deg); }
        4% { transform: rotateY(-80deg); }
        5% { transform: rotateY(-4deg); }
        6% { transform: rotateY(-80deg); }
        7% { transform: rotateY(-4deg); }
        8% { transform: rotateY(-80deg); }
        12% { transform: rotateY(0deg); }
        15% { transform: rotateY(-55deg); }
        18% { transform: rotateY(0deg); }
        100% { transform: rotateY(0deg); }
      }
      @keyframes wings-left {
        0% { transform: rotateY(0deg); }
        1% { transform: rotateY(25deg); }
        3% { transform: rotateY(4deg); }
        4% { transform: rotateY(80deg); }
        5% { transform: rotateY(4deg); }
        6% { transform: rotateY(80deg); }
        7% { transform: rotateY(4deg); }
        8% { transform: rotateY(80deg); }
        12% { transform: rotateY(0deg); }
        15% { transform: rotateY(55deg); }
        18% { transform: rotateY(0deg); }
        100% { transform: rotateY(0deg); }
      }
    </style>
    <div class="leftside">
      <svg id="svg" viewBox="0 0 60 120" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <path class="headoverlay left" fill="#ffc30a" d="M60,0l0,40l-20,-20z"></path>
        <path class="head left" fill="#ffc30a" d="M60,0l0,40l-20,-20z"></path>
        <path class="body left" fill="#ff9c02" d="M60,40l-20,20l0,-40z"></path>
        <!--<path class="tailoverlay left" fill="#ff7702" d="M60,80l0,-40l-20,20z"></path>-->
        <path class="tailoverlay left" fill="#ff7702" d="M40,60l20,20l-20,-20z"></path>
        <path class="tail left" fill="#ff7702" d="M60,40l0,40l-20,-20z"></path>
      </svg>
    </div>
    <div class="rightside">
      <svg id="svg2" viewBox="0 0 60 120" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <path class="headoverlay right" fill="#ffc30a" d="M0,0l0,40l20,-20z"></path>
        <path class="head right" fill="#ffc30a" d="M0,0l0,40l20,-20z"></path>
        <path class="body right" fill="#ff9c02" d="M0,40l20,20l0,-40z"></path>
        <path class="tailoverlay right" fill="#ff7702" d="M0,80l0,-40l20,20z"></path>
        <path class="tail right" fill="#ff7702" d="M0,40l0,40l20,-20z"></path>
      </svg>
    </div>
  </template>
  <script src="snap.svg-min.js"></script>
  <script>
    (function() {
      var colors = {
        oranges: {
          light: '#ffc30a',
          medium: '#ff9c02',
          dark: '#ff7702'
        },
        greys: {
          light: '#999999',
          medium: '#888888',
          dark: '#777777',
          black: '#555555'
        },
        reds: {
          light: '#f00000',
          medium: '#e00000',
          dark: '#d00000',
          black: '#b00000'
        }
      };

      var timing = mina.linear;

      // Left side
      function phase1(snap, duration) {
        snap.select('path.tailoverlay.left').animate({
          // d: 'M60,80l-20,-20l0,40z',
          d: 'M40,60l20,20l-20,20z',
          fill: colors.greys.light
        }, duration, timing);

        snap.selectAll('path.head.left, path.headoverlay.left').animate({
          d: 'M40,20l20,20l-40,0z',
          fill: colors.greys.medium
        }, duration, timing, function() {
          phase2(snap, duration);
        });

        snap.select('path.body.left').animate({
          d: 'M60,40l-20,20l-20,-20z',
          fill: colors.greys.dark
        }, duration, timing);

        snap.select('path.tail.left').animate({
          fill: colors.greys.black
        }, duration, timing);

      }

      function phase2(snap, duration) {
        snap.select('path.headoverlay.left').attr({
          d: 'M40,20l-20,20l20,-20z'
        });
        snap.select('path.headoverlay.left').animate({
          d: 'M40,20l-20,20l-20,-20z',
          fill: colors.greys.light
        }, duration, timing);
      }


      // Right side
      function phase3(snap, duration, opt_callback) {
        snap.select('path.tailoverlay.right').animate({
          d: 'M0,80l20,-20l0,40z',
          fill: colors.reds.light
        }, duration, timing);

        snap.selectAll('path.head.right, path.headoverlay.right').animate({
          d: 'M20,20l-20,20l40,0z',
          fill: colors.reds.medium
        }, duration, timing, function() {
          phase4(snap, duration, opt_callback);
        });

        snap.select('path.body.right').animate({
          d: 'M0,40l20,20l20,-20z',
          fill: colors.reds.dark
        }, duration, timing);

        snap.select('path.tail.right').animate({
          fill: colors.reds.black
        }, duration, timing);
      }

      function phase4(snap, duration, opt_callback) {
        snap.select('path.headoverlay.right').animate({
          d: 'M60,20l-40,0l20,20z',
          fill: colors.reds.light
        }, duration, timing, opt_callback);
        // snap.select('path.headoverlay.right').attr({
        //   d: 'M20,20l20,20l-20,-20z'
        // });
        // snap.select('path.headoverlay.right').animate({
        //   d: 'M20,20l20,20l20,-20z',
        //   fill: colors.reds.light
        // }, duration, timing, opt_callback);
      }

      Polymer({
        is: 'zi-butterfly',
        properties: {
          /**
           * Start the transformation from cacoon to butterfly automatically
           * after the initial delay is elapsed. This is enabled by default.
           */
          auto: {
            type: Boolean,
            value: true
          },
          /**
           * How much time we should wait to start the cacoon to imago
           * transformation for, in seconds. This is only used if auto is true
           * which is the default.
           */
          initialDelay: {
            type: Number,
            value: 2
          },
          /**
           * How much time the cacoon to imago animation sould take.
           */
          transformationDuration: {
            type: Number,
            value: 1200
          }
        },

        /** @override */
        attached: function() {
          if (this.auto) this.__transform();
        },

        /**
         * Start the tranformation from cocoon to imago.
         */
        __transform: function() {
          this.async(function() {
            phase1(Snap(this.$.svg), this.transformationDuration / 2);
            phase3(Snap(this.$.svg2), this.transformationDuration / 2, function() {
              this.__onTranformed();
            }.bind(this));
          }, this.initialDelay * 1000);
        },

        /**
         * The tranformation has ended, we can start butterfly wings.
         */
        __onTranformed: function() {
          // console.log('we are ready', this);
          this.$.svg.classList.add('ready');
          this.$.svg2.classList.add('ready');
        }
      });
    })();
  </script>
</dom-module>
